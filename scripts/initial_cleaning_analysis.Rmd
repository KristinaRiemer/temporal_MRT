---
title: "R Notebook"
output: html_notebook
---

### R packages

```{r echo=FALSE}
library(rdataretriever)
library(dplyr)
library(ggplot2)
library(tidyr)
library(testthat)
```

### Dataset 1: Portal

#### TODO

* Retain only adults; age column == Z? 
* Retain each individual only once? 
* Choose which experimental treatments to use

```{r}
if(!file.exists("../data/raw/portal_dev_rodent_trapping.csv")){
  rdataretriever::install(dataset = "portal-dev", connection = "csv", data_dir = "data/raw/")
}
```
Download all Portal data using dataretriever if it isn't already. 
```{r}
portal_occurrences = read.csv("../data/raw/portal_dev_rodent.csv")
dim(portal_occurrences)
head(portal_occurrences)
```
Read in Portal mammal occurrence data. 

```{r}
#colnames(portal_occurrences)
unique(portal_occurrences$age)
head(unique(portal_occurrences$tag), n = 20)
head(unique(portal_occurrences$ltag), n = 20)
```
Start looking at age class and tags for each occurrence. 
```{r}
portal_species = read.csv("../data/raw/portal_dev_rodent_species.csv")
portal_species
```
Read in species data to remove non-rodent species from occurrence data. 
```{r}
table(portal_species$rodent)
rodent_list = portal_species %>% 
  filter(rodent == 1)
rodent_list
```
Generate list of rodent species. 
```{r}
by_sp_yr = portal_occurrences %>% 
  filter(!is.na(wgt), !is.na(species), species %in% rodent_list$species_code) %>% 
  group_by(species, yr) %>% 
  summarize(mass_mean = mean(wgt), 
            mass_sd = sd(wgt))
by_sp_yr
```
Create new dataframe containing mean and standard deviation of each species' mass for each year, 
removing rows with no weight or no species ID and retaining only rodents. 

The minimum mean mass is `r min(by_sp_yr$mass_mean)` and max is `r max(by_sp_yr$mass_mean)`. 
There are `r length(unique(by_sp_yr$species))` species across `r length(unique(by_sp_yr$yr))` years. 
```{r}
ggplot(data = by_sp_yr, aes(x = yr, y = mass_mean)) +
  geom_errorbar(aes(ymin = mass_mean - mass_sd, ymax = mass_mean + mass_sd)) +
  geom_point() +
  facet_wrap(~species, scale = "free_y")
```
Plot mass mean and sd by species across years.

### Dataset 2: Fray Jorge

##### Notes

* [Mammal metadata](http://www.esapubs.org/archive/ecol/E094/084/Fray_Jorge_Small_Mammal_Metadata.php) 
from ESA Ecological Archives

#### TODO

* Separate month and year (mo) into separate columns
* Get corresponding species names for species code column (sp) from Table 2 in
[metadata](http://www.esapubs.org/archive/ecol/E094/084/Fray_Jorge_Small_Mammal_Metadata.php)
* Double check that mass column (wt) is in grams
* Data only goes to 2005, but the project has been funded since then; are there more years? 
* Determine if precip data also contains temperature
* Choose which experimental treatments to use (trt col)
* Retain only adults (sst column?) 
* Retain each individual only once (AnimalID col)? 

```{r}
if(!file.exists("../data/raw/fray_jorge_ecology_mammals.csv")){
  rdataretriever::install(dataset = "fray-jorge-ecology", connection = "csv", data_dir = "data/raw")
}
```
Download all Fray Jorge data using dataretriever if it isn't already. 
```{r}
fray_occurrences = read.csv("../data/raw/fray_jorge_ecology_mammals.csv")
dim(fray_occurrences)
head(fray_occurrences)
```
Read in Fray Jorge mammal occurrence data. 
```{r}
colnames(fray_occurrences)
range(fray_occurrences$record_date)
```
Explore column contents of Fray Jorge occurrences. 
```{r}
range(fray_occurrences$mo)
range(nchar(fray_occurrences$mo))
```
Check out column combining month and year. 

```{r}
fray_occurrences_test = fray_occurrences %>% 
  separate(mo, into = c("year", "month"), sep = 4, remove = FALSE)
#tail(fray_occurrences_test)
range(fray_occurrences_test$year)
range(nchar(fray_occurrences_test$year))
range(fray_occurrences_test$month)
range(nchar(fray_occurrences_test$month))
```
Separate mo column into year and month columns. 
```{r}
expect_that(10, equals(10))
expect_equal(10, 10)
expect_that(fray_occurrences_test, is_a("data.frame"))
expect_is(fray_occurrences_test, "data.frame")
expect_that(min(nchar(fray_occurrences_test$year)), equals(4))
expect_equal(min(nchar(fray_occurrences_test$year)), 4)
expect_that(max(nchar(fray_occurrences_test$year)), equals(4))
expect_equal(max(nchar(fray_occurrences_test$year)), 4)
```
Experimenting with testing for splitting mo column up. 

##### Tests to include

* Year values are in reasonable range
* Month values are in reasonable range (between 1 and 12, inclusive)

```{r}
library(stringr)

context("String length")

test_that("str_length is number of characters", {
  expect_that(str_length("a"), equals(1))
  expect_that(str_length("ab"), equals(2))
  expect_that(str_length("abc"), equals(3))
})

test_that("str_length of missing is missing", {
  expect_that(str_length(NA), equals(NA_integer_))
  expect_that(str_length(c(NA, 1)), equals(c(NA, 1)))
  expect_that(str_length("NA"), equals(2))
})

test_that("str_length of factor is length of level", {
  expect_that(str_length(factor("a")), equals(1))
  expect_that(str_length(factor("ab")), equals(2))
  expect_that(str_length(factor("abc")), equals(3))
})
```
Examples from `testthat` [documentation](https://journal.r-project.org/archive/2011/RJ-2011-002/RJ-2011-002.pdf). 
