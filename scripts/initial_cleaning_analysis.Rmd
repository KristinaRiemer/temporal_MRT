---
title: "R Notebook"
output: html_notebook
---

### R packages

```{r echo=FALSE}
library(rdataretriever)
library(dplyr)
library(ggplot2)
library(tidyr)
library(testthat)
```

### Dataset 1: Portal

#### TODO

* Retain only adults; age column == Z? 
* Retain each individual only once? 
* Choose which experimental treatments to use

```{r}
if(!file.exists("../data/raw_portal/portal_dev_rodent_trapping.csv")){
  rdataretriever::install(dataset = "portal-dev", connection = "csv", data_dir = "../data/raw_portal/")
}
```
Download all Portal data using dataretriever if it isn't already. 
```{r}
portal_occurrences = read.csv("../data/raw_portal/portal_dev_rodent.csv")
dim(portal_occurrences)
head(portal_occurrences)
```
Read in Portal mammal occurrence data. 

```{r}
#colnames(portal_occurrences)
unique(portal_occurrences$age)
head(unique(portal_occurrences$tag), n = 20)
head(unique(portal_occurrences$ltag), n = 20)
```
Start looking at age class and tags for each occurrence. 
```{r}
portal_species = read.csv("../data/raw_portal/portal_dev_rodent_species.csv")
portal_species
```
Read in species data to remove non-rodent species from occurrence data. 
```{r}
table(portal_species$rodent)
rodent_list = portal_species %>% 
  filter(rodent == 1)
rodent_list
```
Generate list of rodent species. 
```{r}
by_sp_yr = portal_occurrences %>% 
  filter(!is.na(wgt), !is.na(species), species %in% rodent_list$species_code) %>% 
  group_by(species, yr) %>% 
  summarize(mass_mean = mean(wgt), 
            mass_sd = sd(wgt))
by_sp_yr
```
Create new dataframe containing mean and standard deviation of each species' mass for each year, 
removing rows with no weight or no species ID and retaining only rodents. 

The minimum mean mass is `r min(by_sp_yr$mass_mean)` and max is `r max(by_sp_yr$mass_mean)`. 
There are `r length(unique(by_sp_yr$species))` species across `r length(unique(by_sp_yr$yr))` years. 
```{r}
ggplot(data = by_sp_yr, aes(x = yr, y = mass_mean)) +
  geom_errorbar(aes(ymin = mass_mean - mass_sd, ymax = mass_mean + mass_sd)) +
  geom_point() +
  facet_wrap(~species, scale = "free_y")
```
Plot mass mean and sd by species across years.

### Dataset 2: Fray Jorge

##### Notes

* [Mammal metadata](http://www.esapubs.org/archive/ecol/E094/084/Fray_Jorge_Small_Mammal_Metadata.php) 
from ESA Ecological Archives

#### TODO

* Separate month and year (mo) into separate columns
* Get corresponding species names for species code column (sp) from Table 2 in
[metadata](http://www.esapubs.org/archive/ecol/E094/084/Fray_Jorge_Small_Mammal_Metadata.php)
* Double check that mass column (wt) is in grams
* Data only goes to 2005, but the project has been funded since then; are there more years? 
* Determine if precip data also contains temperature
* Choose which experimental treatments to use (trt col)
* Retain only adults (sst column?) 
* Retain each individual only once (AnimalID col)? 

```{r}
if(!file.exists("../data/raw_frayjorge/fray_jorge_ecology_mammals.csv")){
  rdataretriever::install(dataset = "fray-jorge-ecology", connection = "csv", data_dir = "../data/raw_frayjorge/")
}
```
Download all Fray Jorge data using dataretriever if it isn't already. 
```{r}
fray_occurrences = read.csv("../data/raw_frayjorge/fray_jorge_ecology_mammals.csv")
dim(fray_occurrences)
head(fray_occurrences)
```
Read in Fray Jorge mammal occurrence data. 
```{r}
colnames(fray_occurrences)
range(fray_occurrences$record_date)
```
Explore column contents of Fray Jorge occurrences. 
```{r}
range(fray_occurrences$mo)
range(nchar(fray_occurrences$mo))
```
Check out column combining month and year. 

```{r}
fray_occurrences = fray_occurrences %>% 
  separate(mo, into = c("year", "month"), sep = 4, remove = FALSE, convert = TRUE)
```
Separate mo column into year and month columns. 

### Dataset 3: Thibault et al., 2011

Ecological Archives documentation of data [here](http://esapubs.org/archive/ecol/E092/201/). 

```{r}
if(!file.exists("../data/raw_thibault/mammal_community_db_communities.csv")){
  rdataretriever::install(dataset = "mammal-community-db", connection = "csv", data_dir = "../data/raw_thibault/")
}
```
Download all data from Thibault data paper using dataretriever if it isn't already. 

```{r}
thibault_df = read.csv("../data/raw_thibault/mammal_community_db_communities.csv")
head(thibault_df)
```

```{r}
dim(thibault_df)
length(which(!is.na(thibault_df$mass)))
```

```{r}
thibault_df_mass = thibault_df %>% 
  filter(!is.na(mass))
thibault_df_mass
```
Of `r length(unique(thibault_df$site_id))` sites in the entire dataset,
`r length(unique(thibault_df_mass$site_id))` have some mass measures. For sites
with masses, do all occurrences have mass values? 
